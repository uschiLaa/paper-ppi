---
title: Using Scagnostics to find Interesting Projections of Multivariate Data

# to produce blinded version set to 1
blinded: 0

authors: 
- name: Ursula Laa
  thanks: The authors gratefully acknowledge the support of the Australian Research Council
  affiliation: Department of Physics, Monash University
  email: \email{ursula.laa@monash.edu}
  
- name: Dianne Cook
  affiliation: Department of Econometrics and Business Statistics, Monash University
  
- name: Heike Hofmann
  affiliation: Department of Statistics, Iowa State University
  
- name: Hadley Wickham
  affiliation: RStudio
  
- name: Antony Unwin
  affiliation: Department of Mathematics, Augsburg University
  
- name: Katrin Grimm
  affiliation: ???

keywords:
- tour
- projection pursuit 
- statistical graphics
- data visualisation
- exploratory data analysis
- high-dimensional data

abstract: |
  Projection pursuit describes a procedure for searching high-dimensional data for "interesting" low-dimensional projections via the optimization of a criterion function called the projection pursuit index. Most indexes developed focus on finding projections with cluster structure, outliers, or separations between known groups. Here, we are interested in finding projections where the shapes are odd, or where known groups have different shapes despite having the same mean and variance. The new indexes are based on scagnostics, which were originally developed to choose pairs of interesting variables from a large collection. An examination of the properties of the scagnostics is included, and code in the form of an R package is provided.  

bibliography: bibliography.bib
output: rticles::asa_article
---

```{r initial, echo = FALSE, cache = FALSE, include = FALSE}
library(knitr)
opts_chunk$set(
  warning = FALSE, message = FALSE, echo = FALSE, 
  fig.path = 'figure/', cache.path = 'cache/', fig.align = 'center', 
  fig.show = 'hold', cache = TRUE, external = TRUE, dev = "pdf",
  fig.height = 5, fig.width = 8, out.width = "\\textwidth"
)
```

# Introduction

The term "projection pursuit" was coined by @ff74 to describe a procedure for searching high-(say $p$)dimensional data for "interesting" low- dimensional projections ($k=1$ or $2$ usually). The procedure, originally suggested by @kr69, involves defining a criterion function, or index, that measures the "interestingness" of each $k$-dimensional projection of $p$-dimensional data. This criterion function is optimized over the space of all $k$-dimensional projections of $p$-space, searching for both global and local maxima. It is hoped that the resulting solutions reveal low-dimensional structure in the data not necessarily found by methods such as principal component analysis.

A large number of projection pursuit indices have been developed [@f87] [@CBC92] [@Lee05] [@AHC02] [@CEM:CEM2568] [@JS87] [@5508437]. Many of these are developed to detect departure from multivariate normal, which includes clusters or outliers, or nonlinearity. Some have been developed to detect separations between known groups. However, if one wants to find unusual shapes, or shape differences between groups there are no options. One reason, is that it is hard, because defining what is meant by shape is not straightforward. An approach that seems plausible begins with scagnostics, developed by @scag, and explored in @WW08. 

*** Motivating example ??
This could be the pdf fit data, more structure and shape than other datasets we have?


Scagnostics are scatterplot diagnostics. They were primarily developed to extract pairs of interesting variables from a large collection.
XXX (Ursula to fill in based loosely on material at the German language wikipedia page - it would be good to translate this page and provide an English version on wikipedia).
Nine graph-theoretic measures have been defined to characterise scatterplots. They are calculated from a set of elementary building blocks: the convex hull, the alpha hull and the minimal spanning tree (MST). For definiteness all variables are rescaled to a [0,1] intervall, such that all measures will take values between 0 and 1 as well.
The following measures have been defined:

* Outlying: Outliers are defined in non-parametric fashion via the edge length in the MST, where the 25% and 75% quantil edge length define a threshold value $w=q_{75}+1.5(q_{75}-q_{25})$ above which an edge is considered long. The outlying measure is then calculated as $c_{outlying} = \frac{\mathrm{Total\ length\ of\ long\ edges}}{\mathrm{Total\ length\ of\ all\ edges}}$. Note that outlying points are not considered in the calculation of the other measures.
* Skewed: Skewness is defined via the distribution of edge length in the MST, $q_{skew}=\frac{q_{90}-q{50}}{q_{90}-q_{10}}$. This is inverted as $c_{skew}= 1-w(1-q_{skew})$ to account for binning effects that result in decreasing values of $q_{skew}$ with increasing n.
* Sparse: A second measure based on the distribution of edge lenths, we define $c_{sparse} = w q_{90}$. It takes large values if points are concentrated in well separated parts of the plane, and low values if they are distributed approximately on a lattice.
* Clumpy: To indicate the clustering of points the Clumpy measure is defined as $c_{clumpy}=\max\limits_{j}[1-\max\limits_{k}[\frac{length(e_k)}{length(e_j)}]]$ where we maximise the edge length $length(e_k)$ in the smaller of two subgraphs generated by removing a single edge $e_j$ from the MST. Note that $c_{clumpy}$ will take large values (close to one) if a long edge is separating clustered points connected by short edges.
* Striated: We define an edge as striated if they have a large angle with one of the neighboring edges, concretely $cos(angle) < -0.75$, and the corresponding measure $c_{striate} = \frac{Number of striated edges}{Number of all edges}$. FIXME is this really correct? Maybe reason for discreet behaviour observed below..
* Convex: The convex measure is defined as $c_{convex}= w\frac{area(A)}{area(H)}$ where $A$ is the alpha hull and $H$ the convex hull.
* Skinny: The skinnyness of a polygon can be measured as the ratio of the perimiter to the area. We define $c_{skinny} = 1 -  \frac{\sqrt{4\pi area(A)}}{perimeter(A)}$, where the normalisation is chosen such that $c_{skinny} = 0$ for a circle, and values close to one for skinny polygons.
* Stringy: need to check, should be $c_{stringy} = \frac{diameter(MST)}{lenght(MST)}$ where diameter is longest connected path, and lenght the total lenght (sum of all edgest), i.e. we are measuring branch structure, no branches means $c_{stringy}=1$.

Note that in practice, for efficiency and robustness, the measures are calculated from binned data, and after removing outliers.
Moreover, scaling factors are used to mitigate dependence on sample size.
Scagnostics are available in two R packages @LWscagR and @HWscagR. This work is built upon the scagnostics package by @HWscagR because the underlying base is built using C, works across platforms. 

A projection pursuit index, a function of all possible projections of the data, invariably has many "hills and valleys" and "knife-edge ridges" because of the varying shapes in the underlying density of observations from one projection to the next. From an exploratory data analysis perpective it is interesting to combine numerical optimisation with visualisation to watch the structure of the data moving into a maximum, to jump away from this projection and follow the optimisation again, invariably moving from local maxima to local maxima, and perhaps even a global maximum. Each of these maxima can reveal different information about the data. Projection pursuit optimisation combined with geodesic interpolations between projections provided by a tour [@As85], is called a projection pursuit guided tour [@CBCH94]. Software to run a projection pursuit guided tour is available in the R package, "tourr" [@tourr].

The paper investigates the nature of scagnostics, particularly when considered as candidates for projection pursuit indices (Section \ref{sec:investigate})). It develops indexes for finding shapes as defined by the scagnostics, and for finding different shapes between multiple groups (Section \ref{sec:indexes}). Changes to the optimisation of the projection pursuit guided tour were needed to accommodate some of the complexities of the scagnostic indexes. The new guided tour methods are applied to contemporary problems from paarticle physics (Section \ref{sec:phys}). The paper is accompanied by the R package "binostics" available on CRAN, and the new indices have been implemented in the "tourr" package. 

# Investigation of scagnostics
\label{sec:investigate}

```{r load}
library(tourr)
library(tidyverse)
library(reshape2)
library(binostics) #https://github.com/uschiLaa/binostics
library(gridExtra)
library(wesanderson) #color palette
library(tictoc) #timer
library(mbgraphic) #Katrins package
library(dfoptim)
library(GGally)
library(geozoo)
```

The nine scagnostics measures are designed to be computed together, producing a matrix of values with dimensions corresponding to the number of all pairs of variables, and the number of scagnostics. If there are 100 variables, the dimension will be $4950x9$. It is typically used to extract the pairs of variables that have the highest scagnostic values, and thus considered to be the most interesting. It can also be used to do more in-depth exploratory analysis, and is interesting to study the distribution of the scagnostics resulting from the data, as a data set in itself. In a sense this the data's "fingerprint".

To use scagnostics for projection pursuit requires that each of the measures for functions that are relatively smooth over the space of all 2D projections, and that they can be computed rapidly enough that the display can be updated many times a second during optimisation.

## Dataset

As a test dataset we generate high dimensional geometrical shapes using the geozoo package (REF).
Concretely we consider five dimensional objects, and we combine a hollow shpere with radius 1 and a solid torus with radii (0.5, 0.5, 0.1,0.1). The resulting distributions can be seen in the scatter plot matrix below. In the following we combine both groups to study the resulting non-standard distribution.

```{r geozooDist, fig.width=6, fig.height=7, fig.cap="Scatter plot matrix of the five dimensional shapes, randomly selecting 500 points in each group. Group 1 (2) contains points selected on a hollow sphere (solid torus)."}
hSphere <- sphere.hollow(p=5,n=500)$points
sTorus <- torus(5,500, radius = c(0.5,0.5,0.1,0.1))$points
geoDF <- bind_rows(as.data.frame(hSphere),as.data.frame(sTorus),.id = "Group")
ggscatmat(geoDF, columns = 2:6, color="Group")
```

## Smoothness
*** temporal trace of scagnostics showing discreteness, with projections illustrating little difference

*** katrin's work

XXX Probably use a simple benchmark data to illustrate the issues, maybe mtcars that comes with the scagnostics package


We first study the smoothness of the scagnostics measures calculated on a sequence of 2-d projections obtained via an interpolated grand tour path. The temporal trace of all nine measures is shown below, where each time step refers to an interpolation step with a target distance between interpolated bases is set to 0.05 radians. We observe sharp jumps in almost all measures (with "Monotonic" being the only exception), note however the large differences in overall scale between the measures. In particular "Clumpy", "Monotonic", "Outlying", "Sparse" and "Striated" show little sensitivity, as could be expected from the distributions in Figure (REF).

```{r util}
scagIndex <- function(scagType){
  function(mat){
    sR <- scagnostics.default(mat[,1],mat[,2])$s
    return(sR[scagType])
  }
}

plotProj <- function(nProj, fullPath, dMatrix,legendOn, lim=75){
  p <- fullPath[nProj][[1]]
  d <- as.matrix(dMatrix) %*% p
  s <- scagnostics.default(d[,1],d[,2], bins= 50)
  p1 <- ggplot()+
    geom_point(data = as.data.frame(d), mapping=aes(x=V1, y=V2))
  p2 <- ggplot()+
    geom_point(data = as.data.frame(s$bins), mapping = aes(x=V1, y=V2, color=V3, size=V3))+
    xlim(0,1000)+
    ylim(0,1000)+
    expand_limits(colour = c(1,lim), size = c(1,lim))+
    scale_color_gradientn(colors=wes_palette(name="Zissou"))+
    scale_size(range = c(1,3))
    if(legendOn==0){p2 = p2 + guides(color=FALSE, size=FALSE)}
    grid.arrange(arrangeGrob(p1, widths = 2),arrangeGrob(p2, widths = 7),nrow=1)
    return(s$s)
}
```

```{r tourpathGeozoo}
set.seed(272829)
geoCombined <- select(geoDF,-Group)
t1 <- save_history(geoCombined, grand_tour(2), max=4)
t1full <- as.list(interpolate(t1))
n <- length(t1full)
sc <- NULL
for (i in 1:n) {
  dprj <- as.matrix(geoCombined) %*% t1full[[i]]
  sc <- rbind(sc, scagnostics(dprj))
}
sc <- as.data.frame(sc)
sc$t <- 1:n
scPairs <- sc
sc <- sc %>% gather(index, value, -t)
```

```{r plotscagGeozoo, fig.width=6, fig.height=7, fig.cap="Short tour paths with scagnostics computed on projections. Most of the indices exhibit sharp jumps in scagnostic value."}
ggplot(sc, aes(x=t, y=value)) + geom_line() + 
  facet_wrap(~index, ncol=1, scales = "free_y") +
  geom_vline(mapping = aes(xintercept=24, color="red")) +
  geom_vline(mapping = aes(xintercept=39, color="red")) +
  guides(color=FALSE)
```

```{r plotscagPairs, fig.width=6, fig.height=7, fig.cap="Short tour paths with scagnostics computed on projections, as above. Scatter plot of scagnostics calculated on each projection. Observations: discreetness of outlying and striated, anti-correlation of convex and skinny. FIXME is this relevant? Maybe remove this plot."}
ggpairs(scPairs, columns = 1:9)
```

Two projections, t=24 and t=39, have been marked in Figure (can I add a reference?), as examples exhibiting jumps in several measures with respect to the previous and/or next projection. In particular the outlying measure indicates that at least one outlier has been identified in the projection at t=24, but not the projections before or after. The removal of the point(s) will likely impact the calculation of other measures, and indeed we even see a small bump in the otherwise smooth measure "monotonic" (note however that the same is not true in other projections with outlying points). The projection at t=39 has been selected because of the sharp jumps in the measures "skewed", "stringy" and "striated". We compare the observed behaviour to the scatter plots obtained from the projected data in the Figure below. As expected the projections look similar over the 3 interpolation steps, small differences in the binned distribution can however be observed. Certainly the sometimes large differences (jumps of 0.1 absolute change in a measure from one projection to the next) are not indicating interesting differences in the projected view of the data.

```{r plotProj15, fig.width=6, fig.height=2, fig.cap="Projected data at t = 23, 24, 25 (top to bottom)."}
s1 <- plotProj(23, t1full, geoCombined, legendOn=0)
s2 <- plotProj(24, t1full, geoCombined, legendOn=0)
s3 <- plotProj(25, t1full, geoCombined, legendOn=0)
```

```{r plotProj25, fig.width=6, fig.height=2, fig.cap="Projected data at t = 38, 39, 40 (top to bottom). The original data points are shown on the left, the binned data, used for the calculation of the scagnostics measures is shown on the right."}
s1 <- plotProj(38, t1full, geoCombined, legendOn=0)
s2 <- plotProj(39, t1full, geoCombined, legendOn=0)
s3 <- plotProj(40, t1full, geoCombined, legendOn=0)
```


## Effect of binning

Two possible sources of discreet jumps, from binning and discreetness of the underlying objects, in particular the minimal spanning tree. Can we see how mst looks for each projection to understand this?

## Speed


# Possible modifications
We next study possible modifications that will enable the use of scagnostics as an index for guided tours.
First, given the often large variation in scagnositcs measures between neighbouring projections, we consider smoothing the calculation, either via averaging over $n$ previous projections, or by jittering either the points or the projection matrix and averaging the resulting scagnostics measures over jittered projections.
We then consider how different optimizers may be more adapt for an optimization over the erratic scagnostics measures.

## Smoothing
First we consider smoothing the scagnostics index by averaging over $n$ previous projections, the resulting behaviour is shown in Figure...


## Jittering
Another method of smoothing the scagnostics index would consist in jittering either the projected data points, or the projection itself.
We show the impact of both methods in Figure ...

## Tour optimisation
How does current optimizer work? What is the advantege of the alternative optimizer? Show results we get using each optimizer


# Scagnostics indices
\label{sec:indexes}

## Individual 


## Two group differences


## Multiple group differences


# Application to particle physics data
\label{sec:phys}

## Data description

## Software setup

## Scagnostics of grand tour projections

# Discussion

# References
